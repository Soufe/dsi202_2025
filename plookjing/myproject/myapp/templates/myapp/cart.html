{% extends 'base.html' %}
{% load static %}

{% block title %}‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ | PLOOKJING{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto p-6 space-y-10">
  <h1 class="text-3xl font-bold text-green-800 mb-6">üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</h1>

  <form method="POST" action="{% url 'myapp:checkout_selected' %}" id="cart-form">
    {% csrf_token %}

    {% for category, items in [('‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ', tree_items), ('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå', equipment_items)] %}
      <div>
        <h2 class="text-xl font-semibold text-green-700 mb-3">{{ category }}</h2>
        {% if items %}
          <div class="space-y-4">
            {% for item in items %}
              <div class="flex items-center justify-between bg-white p-4 rounded-xl shadow">
                <div class="flex items-center gap-4">
                  <input type="checkbox" name="selected_items" value="{{ item.id }}" class="form-checkbox mt-1 text-green-600 item-checkbox">
                  {% if item.image %}
                    <img src="{{ item.image.url }}" alt="{{ item.name }}" class="w-20 h-20 object-cover rounded-lg border">
                  {% else %}
                    <div class="w-20 h-20 bg-gray-100 text-gray-400 flex items-center justify-center rounded-lg">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ</div>
                  {% endif %}
                  <div>
                    <p class="font-semibold text-gray-800">{{ item.name }}</p>
                    <p class="text-orange-600 font-bold">‡∏ø{{ item.price|floatformat:2 }}</p>
                    <div class="flex items-center mt-1 space-x-2">
                      <button type="button" class="qty-btn px-2 bg-gray-200 rounded" data-action="decrease" data-id="{{ item.id }}">‚àí</button>
                      <span class="quantity font-medium" id="qty-{{ item.id }}">{{ item.quantity }}</span>
                      <button type="button" class="qty-btn px-2 bg-gray-200 rounded" data-action="increase" data-id="{{ item.id }}">+</button>
                    </div>
                  </div>
                </div>
                <div class="flex flex-col items-end gap-2">
                  {% if category == '‡∏ï‡πâ‡∏ô‡πÑ‡∏°‡πâ' %}
                    <a href="{% url 'myapp:tree_order' item.id %}" class="px-4 py-2 text-sm bg-green-600 text-white rounded hover:bg-green-700 shadow">‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</a>
                  {% endif %}
                  <form method="POST" action="{% url 'myapp:update_quantity' item.id %}">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="remove">
                    <button type="submit" class="text-xs text-red-400 hover:text-red-600">‡∏•‡∏ö</button>
                  </form>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ{{ category|lower }}‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>
        {% endif %}
      </div>
    {% endfor %}

    <!-- ‚úÖ ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î + ‡∏õ‡∏∏‡πà‡∏°‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô -->
    <div class="flex justify-between items-center mt-10 bg-gray-100 p-4 rounded-lg">
      <p class="text-xl font-bold text-green-800">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å: ‡∏ø<span id="total">0.00</span></p>
      <button type="submit" class="px-6 py-3 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-semibold shadow">
        üßæ ‡πÑ‡∏õ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      </button>
    </div>
  </form>
</div>

<script>
  // ‚úÖ ‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
  const checkboxes = document.querySelectorAll('.item-checkbox');
  const totalEl = document.getElementById('total');
  const prices = {};
  {% for item in tree_items %}
    prices[{{ item.id }}] = {{ item.price }};
  {% endfor %}
  {% for item in equipment_items %}
    prices[{{ item.id }}] = {{ item.price }};
  {% endfor %}

  function updateTotal() {
    let total = 0;
    checkboxes.forEach(chk => {
      if (chk.checked) {
        const id = chk.value;
        const qty = document.getElementById('qty-' + id).textContent;
        total += prices[id] * parseInt(qty);
      }
    });
    totalEl.textContent = total.toFixed(2);
  }

  checkboxes.forEach(chk => chk.addEventListener('change', updateTotal));

  // ‚úÖ ‡∏õ‡∏∏‡πà‡∏° + -
  document.querySelectorAll('.qty-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const id = btn.dataset.id;
      const action = btn.dataset.action;
      const qtyEl = document.getElementById('qty-' + id);
      let qty = parseInt(qtyEl.textContent);
      qty = (action === 'increase') ? qty + 1 : Math.max(1, qty - 1);
      qtyEl.textContent = qty;
      updateTotal();
    });
  });
</script>
{% endblock %}